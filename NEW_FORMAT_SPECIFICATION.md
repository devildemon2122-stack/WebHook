# New Webhook Payload Format Specification

## Overview
This document describes the new payload format that will be sent to the backend when saving webhook requests, as specified by the lead.

## Payload Structure

```json
{
  "name": "Order Webhook",
  "endpoint": "https://api.example.com/webhook/orders",
  "method": "POST",
  "authType": "API_KEY",
  "tenantId": "T123",
  "webhookParams": [
    {
      "paramName": "Authorization",
      "paramValue": "Bearer xyz",
      "paramType": "HEADER",
      "bodyMode": "NONE",
      "envCode": "DEV"
    },
    {
      "paramName": "limit",
      "paramValue": "100",
      "paramType": "QUERY_PARAM",
      "bodyMode": "NONE",
      "envCode": "DEV"
    }
  ],
  "environments": [
    {
      "envCode": "DEV",
      "baseUrl": "https://dev.api.example.com",
      "key": "key1",
      "value": "value1"
    },
    {
      "envCode": "PROD",
      "baseUrl": "https://api.example.com",
      "key": "key2",
      "value": "value2"
    }
  ]
}
```

## Field Descriptions

### Top Level Fields
- **name**: The name of the webhook request
- **endpoint**: The full URL endpoint for the webhook
- **method**: HTTP method (GET, POST, PUT, DELETE, etc.)
- **authType**: Authentication type (NO_AUTH, API_KEY, BEARER_TOKEN, BASIC_AUTH)
- **tenantId**: Unique tenant identifier (auto-generated)
- **webhookParams**: Array of parameters (headers, query params, path params, auth)
- **environments**: Array of environment configurations

### Webhook Parameters
- **paramName**: Parameter name/key
- **paramValue**: Parameter value
- **paramType**: Parameter type (HEADER, QUERY_PARAM, PATH_PARAM)
- **bodyMode**: Always "NONE" for now (reserved for future use)
- **envCode**: Environment code (DEV, PROD, TEST, etc.)

### Environment Configuration
- **envCode**: Environment identifier
- **baseUrl**: Base URL for the environment
- **key**: Environment variable key or environment name
- **value**: Environment variable value or environment description

## Implementation Details

### Transform Function
The new format is generated by the `buildNewFormatPayload()` function in `src/utils/payloads.js`.

### Usage
```javascript
import { buildNewFormatPayload } from '../utils/payloads'

const payload = buildNewFormatPayload(
  requestData,           // Current request data
  name,                  // Request name
  description,           // Request description
  currentEnvironment,    // Current environment context
  allEnvironments,       // All available environments
  authType,              // Current authentication type
  authConfig             // Current authentication configuration
)
```

### Automatic Transformations

#### Headers → HEADER Parameters
All request headers are automatically converted to HEADER type parameters.

#### Query Parameters → QUERY_PARAM Parameters
URL query parameters are converted to QUERY_PARAM type parameters.

#### Path Parameters → PATH_PARAM Parameters
URL path parameters are converted to PATH_PARAM type parameters.

#### Authentication → HEADER/QUERY_PARAM Parameters
- **API Key**: Added as header or query param based on configuration
- **Bearer Token**: Added as Authorization header
- **Basic Auth**: Added as Authorization header with base64 encoding

#### Environment Variables
- Reserved variables (ENV_CODE, base_URL) are automatically included
- Custom environment variables are preserved
- Environment codes are converted to uppercase

## Backend Integration

### API Endpoint
The payload is sent to the backend via the existing `saveRequestToBackend()` function.

### Validation
The frontend validates the request before transformation, but the backend should also validate:
- Required fields (name, endpoint, method)
- Valid HTTP methods
- Valid authentication types
- Valid parameter types
- Environment code consistency

### Response Format
The backend should respond with:
```json
{
  "success": true,
  "data": {
    "id": "webhook_123",
    "name": "Order Webhook",
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
}
```

## Migration Notes

### Backward Compatibility
- The old `buildSavePayload()` function is preserved for backward compatibility
- The new format is only used when calling `saveRequestToBackend()`
- Local saves still use the old format

### Testing
- Use the save dialog preview to verify the payload format
- Check browser console for the logged payload
- Test with different authentication types and environments

## Future Enhancements

### Body Mode Support
The `bodyMode` field is reserved for future use to support:
- JSON body parameters
- Form data parameters
- XML body parameters
- Binary file parameters

### Advanced Parameter Types
Future parameter types could include:
- PATH_PARAM for URL path segments
- BODY_PARAM for request body parameters
- COOKIE_PARAM for cookie parameters
- CUSTOM_PARAM for custom parameter types
